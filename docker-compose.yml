# This docker-compose file starts all 3rd party services
# and builds/runs our 2 custom Spring Boot services.

services:
  
  # 1. Zookeeper (Required for Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    hostname: zookeeper
    container_name: zookeeper-sprint # Renamed
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  # 2. Kafka (Depends on Zookeeper)
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    hostname: kafka
    container_name: kafka-sprint # Renamed
    ports:
      - "9092:9092" 
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_INTERNAL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_INTERNAL://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    depends_on:
      - zookeeper

  # 3. MongoDB
  mongodb:
    image: mongo:6.0.4
    hostname: mongodb
    container_name: mongodb-sprint # Renamed
    ports:
      - "27017:27017"

  # 4. NEW: DynamoDB (This was missing)
  dynamodb:
    image: amazon/dynamodb-local:latest
    hostname: dynamodb
    container_name: dynamodb-sprint # Renamed
    ports:
      - "8000:8000" # Expose DynamoDB's port
    command: "-jar DynamoDBLocal.jar -inMemory -sharedDb"

  # 5. user-api-service (Builds from your local Dockerfile)
  user-api-service:
    build:
      context: ./UserApiService/UserApiService
      dockerfile: Dockerfile
    hostname: user-api-service
    container_name: user-api-service-sprint # Renamed
    ports:
      - "8080:8080" # Expose to host
    environment:
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    depends_on:
      - kafka
      - mongodb

  # 6. profile-api-service (Builds from your local Dockerfile)
  profile-api-service:
    build:
      context: ./ProfileService/ProfileService
      dockerfile: Dockerfile
    hostname: profile-api-service
    container_name: profile-api-service-sprint # Renamed
    ports:
      - "8081:8080" # Expose to host on a DIFFERENT port
    environment:
      # [THE FIX]: Tell Spring how to find the dynamodb container
      AWS_DYNAMODB_ENDPOINT: http://dynamodb:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
    depends_on:
      - dynamodb # This service now depends on dynamodb